{% extends "base.html" %}
{% block content %}

<script defer src="https://cdn.jsdelivr.net/npm/mathlive"></script>

<style>
  /* Ocultar botones del teclado virtual de MathLive */
  math-field::part(virtual-keyboard-toggle),
  math-field::part(menu-toggle) {
    display: none !important;
  }

  /* Estilo de los math-field dentro de las celdas de la matriz */
  .matrix-table td math-field {
    display: block;
    width: 100%;
    height: 100%;
    padding: 0.25rem 0.5rem;
    box-sizing: border-box;
    border-radius: 0.75rem;
    border: none;
    background: transparent;
    color: inherit;
  }

  .matrix-table td math-field::part(content) {
    color: inherit;
  }

  /* ===============================
     TARJETAS DE PASOS (MISMO ESTILO QUE MATRIZ PRINCIPAL)
     =============================== */

  .dark #contenedor-pasos .card-paso {
    background-color: #0b1120 !important;   /* panel oscuro como el resto */
    border: 1px solid #1e293b !important;   /* mismo borde que la matriz */
    border-radius: 1rem !important;         /* mismo redondeado */
    padding: 1.25rem !important;
    color: #e5e7eb !important;              
  }

  /* ===============================
     TABLA DE LOS PASOS (colores exactos)
     =============================== */

  /* Encabezados (x1, x2, x3, b) */
  .dark #contenedor-pasos .matrix-table th {
    background-color: #1e293b !important;  /* header azul oscuro (como matriz principal) */
    color: #e5e7eb !important;
    font-weight: 600;
    border: 1px solid #334155 !important;
  }

  /* Celdas del cuerpo */
  .dark #contenedor-pasos .matrix-table td {
    background-color: #0f172a !important;  /* exacto tono de filas */
    color: #e5e7eb !important;
    border: 1px solid #334155 !important;
  }

  /* Eliminar listrado */
  .dark #contenedor-pasos .matrix-table tr:nth-child(even) td,
  .dark #contenedor-pasos .matrix-table tr:nth-child(odd) td {
    background-color: #0f172a !important;
  }
</style>



<div class="space-y-8">
  <!-- =================== PANEL DATOS / SISTEMA =================== -->
  <section class="panel">
    <h2 class="panel-title text-slate-900">Datos de la matriz</h2>

    <!-- Controles clásicos de matriz -->
    <div class="grid grid-cols-1 sm:grid-cols-5 gap-4 items-end">
      <label class="block">
        <span class="lbl">Ecuaciones (filas)</span>
        <input
          id="inp-filas"
          type="number"
          min="1"
          max="100"
          value="3"
          class="input"
        />
      </label>
      <label class="block">
        <span class="lbl">Incógnitas (columnas sin b)</span>
        <input
          id="inp-columnas"
          type="number"
          min="1"
          max="100"
          value="3"
          class="input"
        />
      </label>
      <label class="block">
        <span class="lbl">Precisión</span>
        <select id="sel-precision" class="input">
          <option value="fraccion">Fracciones exactas</option>
          <option value="decimal">Decimales</option>
        </select>
      </label>
      <label class="block">
        <span class="lbl">Decimales (si aplica)</span>
        <input
          id="inp-decimales"
          type="number"
          min="0"
          max="12"
          value="6"
          class="input"
        />
      </label>
      <div class="block">
        <button id="btn-crear" class="btn-primary w-full">Crear Matriz</button>
      </div>
    </div>

    <!-- NUEVO: SISTEMA DE ECUACIONES → MATRIZ -->
    <div class="mt-6 space-y-3">
      <h3 class="text-base font-semibold text-slate-900">
        Sistema de ecuaciones (opcional)
      </h3>

      <p class="text-sm text-slate-600">
        Escribe un sistema lineal y luego usa
        <span class="font-semibold">“Cargar sistema en matriz”</span>
        para que se llene la matriz aumentada automáticamente.
      </p>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <!-- Lado izquierdo: textarea con el sistema -->
        <div class="space-y-2">
          <label for="txt-sistema" class="lbl">Sistema</label>
          <textarea
            id="txt-sistema"
            class="input w-full min-h-[140px]"
            placeholder="Ejemplo:
            2x + 3y - z = 5
            x - y + 4z = 7
            -x + 2y + z = 1"
          ></textarea>
          <p class="text-xs text-slate-500">
            Una ecuación por línea, siempre con <code>=</code>.
            Puedes usar cualquier letra para las incógnitas (x, y, z, a, b, ...).
          </p>
        </div>

        <!-- Lado derecho: orden de variables + botón -->
        <div class="space-y-3">
          <div class="space-y-2">
            <label for="inp-variables-sistema" class="lbl">
              Orden de las variables (opcional)
            </label>
            <input
              id="inp-variables-sistema"
              type="text"
              class="input w-full"
              placeholder="x, y, z"
            />
            <p class="text-xs text-slate-500">
              Si lo dejas vacío, más adelante el programa podrá detectar las
              variables y ordenarlas alfabéticamente.
            </p>
          </div>

          <div>
            <button
              id="btn-sistema-a-matriz"
              type="button"
              class="btn-accent w-full"
            >
              Cargar sistema en matriz
            </button>
            <p class="text-xs text-slate-500 mt-1">
              Este botón rellenará la matriz aumentada con los coeficientes
              y el término independiente <em>b</em> según el sistema escrito.
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- =================== MATRIZ / TECLADO =================== -->
  <section id="zona-tabla" class="panel hidden">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold text-slate-900">
        Matriz aumentada (coeficientes | b)
      </h3>
      <div class="text-sm text-slate-500">
        Última columna: término independiente <em>b</em>.
      </div>
    </div>

    <div
      class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm mb-6"
      id="tabla-scroll"
    >
      <table id="tabla-matriz" class="matrix-table w-full"></table>
    </div>

    <div class="mt-4 keypad">
      <button class="key" data-ins="(">(</button>
      <button class="key" data-ins=")">)</button>
      <button class="key" data-ins="+">+</button>
      <button class="key" data-ins="-">−</button>
      <button class="key" data-ins="*">×</button>
      <button class="key" data-ins="/">÷</button>
      <button class="key" data-ins="x^">x²</button>
      <button class="key" data-ins="sqrt()">√</button>
      <button class="key" data-ins="sin()">sin</button>
      <button class="key" data-ins="cos()">cos</button>
      <button class="key" data-ins="tan()">tan</button>
      <button class="key" data-ins="pi">π</button>
      <button class="key" data-ins="e">e</button>
      <button class="key wide" data-ins="frac(, )">a/b</button>
      <span class="tip">
        Tip: usa <code>frac(a,b)</code> o <code>3/4</code>.
      </span>
    </div>

    <div class="mt-6">
      <h4 class="font-semibold text-slate-900 mb-2">
        Opciones de llenado rápido
      </h4>
      <div class="fill-row">
        <button class="fill-btn" data-fill="identidad">Identidad</button>
        <button class="fill-btn" data-fill="nula">Nula</button>
        <button class="fill-btn" data-fill="tsup">Triangular Superior</button>
        <button class="fill-btn" data-fill="tinf">Triangular Inferior</button>
      </div>
      <p class="note">
        Triangulares/identidad requieren coeficientes cuadrados. <em>b</em> no
        se toca salvo en Nula.
      </p>
    </div>

    <div class="mt-6 flex flex-wrap items-center gap-3">
      <button id="btn-resolver" class="btn-accent">Resolver</button>
      <span id="msg" class="text-sm text-slate-500"></span>
    </div>
  </section>

  <!-- =================== PASOS =================== -->
  <section id="zona-pasos" class="space-y-4 hidden">
    <h3 class="text-lg font-semibold text-slate-900">Pasos</h3>
    <div id="contenedor-pasos" class="space-y-6"></div>
  </section>

  <!-- =================== RESPUESTA FINAL =================== -->
  <section id="zona-final" class="panel final-card hidden">
    <h3 class="text-lg font-semibold mb-2 text-slate-900">Respuesta final</h3>
    <p id="final-desc" class="text-slate-800"></p>
    <ul id="final-sol" class="mt-3 grid sm:grid-cols-2 gap-2"></ul>
    <div class="mt-6">
      <button id="btn-pdf" class="btn-ghost">Descargar PDF</button>
    </div>
  </section>

  <!-- =================== ZONA IA =================== -->
  <section id="zona-ia" class="panel hidden">
    <h3 class="text-lg font-semibold mb-2 text-slate-900">
      Consulta IA (opcional)
    </h3>
    <p class="text-slate-600 mb-2">
      Describe aquí el contexto del ejercicio o tu pregunta. Luego de resolver,
      puedes enviar esto a la IA para obtener un criterio corto sobre variables
      libres.
    </p>
    <textarea
      id="ia-contexto"
      class="input w-full min-h-[120px]"
      placeholder="Escribe el enunciado del ejercicio o tu duda..."
    ></textarea>
    <div class="mt-3 flex gap-3">
      <button id="btn-ia" class="btn-accent">Preguntar a IA</button>
      <span id="ia-msg" class="text-sm text-slate-500"></span>
    </div>
    <pre
      id="ia-out"
      class="mt-3 p-3 rounded-lg bg-slate-50 text-slate-800 whitespace-pre-wrap hidden"
    ></pre>
  </section>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/gauss.js') }}?v=3"></script>
{% endblock %}
